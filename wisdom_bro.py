import argparse
import datetime
import os

from openai import OpenAI

from config import ANALYSIS_DIR, JOURNAL_DIR, OLLAMA_API_URL, OLLAMA_MODEL
from utils import ensure_ollama, log, send_notification

SYSTEM_PROMPT = """
–¢—ã ‚Äî –º–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –∂–∏–∑–Ω–∏ –∏ –∫–æ—É—á –ø–æ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ Kaizen (–Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è).
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–æ–∏ –¥–Ω–µ–≤–Ω–∏–∫–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –∏ –Ω–∞—Ö–æ–¥–∏—Ç—å –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –º–æ–∏–º —Ñ–∏–∑–∏—á–µ—Å–∫–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º, –º–æ–∏–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏ –∏ –æ–±—â–∏–º –æ—â—É—â–µ–Ω–∏–µ–º –æ—Ç –∂–∏–∑–Ω–∏.
–ë—É–¥—å –æ–±—ä–µ–∫—Ç–∏–≤–µ–Ω, –∏—â–∏ –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≥–∏–ø–æ—Ç–µ–∑—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.
–¢–≤–æ–π —Å—Ç–∏–ª—å ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π, –Ω–æ —Ä–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ –¥–∞–Ω–Ω—ã–µ.
"""

# --- –¢–ò–ü–´ –ê–ù–ê–õ–ò–ó–ê ---
ANALYSIS_TYPES = {
    "weekly_retro": {
        "name": "–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π —Ä–µ—Ç—Ä–æ—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑",
        "days": 7,
        "filename_slug": "–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–µ–†–µ—Ç—Ä–æ",
        "system": SYSTEM_PROMPT,
        "prompt_template": """
–¢–≤–æ—è —Ü–µ–ª—å ‚Äî –Ω–∞–π—Ç–∏ —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Å–Ω–æ–º, –±–æ–ª—è–º–∏, –¥–µ–π—Å—Ç–≤–∏—è–º–∏ –∏ –æ—Ü–µ–Ω–∫–æ–π –¥–Ω—è.
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–æ–∏ –¥–Ω–µ–≤–Ω–∏–∫–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π.
–î–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏. –í –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏ –µ—Å—Ç—å —Ä–∞–∑–¥–µ–ª—ã (–°–æ–Ω, –ë–æ–ª–∏, –£—Å–ø–µ—Ö–∏, –û—Ü–µ–Ω–∫–∞, –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç).

–ü–æ–¥–≥–æ—Ç–æ–≤—å –æ—Ç—á–µ—Ç:
1. **–ì—Ä–∞—Ñ–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è:** –ö–∞–∫ –º–µ–Ω—è–ª–∞—Å—å –û—Ü–µ–Ω–∫–∞ –î–Ω—è? –ï—Å—Ç—å –ª–∏ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Å–æ –°–Ω–æ–º?
2. **–ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –±–æ–ª–∏:** –ë—ã–ª–∏ –ª–∏ –±–æ–ª–∏? –ß—Ç–æ –∏–º –ø—Ä–µ–¥—à–µ—Å—Ç–≤–æ–≤–∞–ª–æ –≤ –∑–∞–ø–∏—Å—è—Ö –∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–Ω–∏?
3. **–ö–ª—é—á–µ–≤—ã–µ —Ç–µ–º—ã –Ω–µ–¥–µ–ª–∏:** –û —á–µ–º —è –≥–æ–≤–æ—Ä–∏–ª –≤ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞—Ö —á–∞—â–µ –≤—Å–µ–≥–æ (—Ç—Ä–µ–≤–æ–≥–∏, –∏–¥–µ–∏, –ª—é–¥–∏)?
4. **–ò–Ω—Å–∞–π—Ç –Ω–µ–¥–µ–ª–∏:** –û–¥–Ω–∞ –Ω–µ–æ—á–µ–≤–∏–¥–Ω–∞—è —Å–≤—è–∑—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–¢—ã —á—É–≤—Å—Ç–≤—É–µ—à—å —Å–µ–±—è –ª—É—á—à–µ, –∫–æ–≥–¥–∞...").
5. **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û–¥–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é.
""",
    },
    "health_check": {
        "name": "–î–µ—Ç–µ–∫—Ç–æ—Ä –≤—ã–≥–æ—Ä–∞–Ω–∏—è (Health Check)",
        "days": 15,
        "filename_slug": "–î–µ—Ç–µ–∫—Ç–æ—Ä–í—ã–≥–æ—Ä–∞–Ω–∏—è",
        "system": SYSTEM_PROMPT,
        "prompt_template": """
–í–æ–∑—å–º–∏ —Ä–æ–ª—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤—ã—è–≤–ª—è—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏ —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–æ–≥–æ —Å—Ç—Ä–µ—Å—Å–∞ –∏ –≤—ã–≥–æ—Ä–∞–Ω–∏—è.
–ò–∑—É—á–∏ –∑–∞–ø–∏—Å–∏ –∑–∞ 14 –¥–Ω–µ–π. –°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Å—è –Ω–∞ —Ä–∞–∑–¥–µ–ª–∞—Ö [–ë–æ–ª–∏] –∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–∞—Ö –≤ [–ü–æ–ª–Ω–æ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–µ].

–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã:
1. –ï—Å—Ç—å –ª–∏ —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∂–∞–ª–æ–±—ã, –∫–æ—Ç–æ—Ä—ã–µ —è –∏–≥–Ω–æ—Ä–∏—Ä—É—é –∏–ª–∏ —Å—á–∏—Ç–∞—é "–Ω–æ—Ä–º–æ–π"?
2. –ö–∞–∫–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–µ —á–∞—â–µ –≤—Å–µ–≥–æ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –ø–æ—è–≤–ª–µ–Ω–∏—é –∑–∞–ø–∏—Å–µ–π –≤ —Ä–∞–∑–¥–µ–ª–µ [–ë–æ–ª–∏] –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å?
3. **–í–µ—Ä–¥–∏–∫—Ç:** –ù–∞–ø–∏—à–∏ "–í–ù–ò–ú–ê–ù–ò–ï", –µ—Å–ª–∏ –≤–∏–¥–∏—à—å –ø—Ä–∏–∑–Ω–∞–∫–∏ –≤—ã–≥–æ—Ä–∞–Ω–∏—è (—Å–Ω–∏–∂–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫, —Ä–æ—Å—Ç —É—Å—Ç–∞–ª–æ—Å—Ç–∏/—Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏—è). –ï—Å–ª–∏ –≤—Å–µ –æ–∫ ‚Äî –Ω–∞–ø–∏—à–∏ "–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ".
""",
    },
    "success_recipe": {
        "name": "–ü–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–∞ —É—Å–ø–µ—Ö–∞",
        "days": 30,
        "filename_slug": "–£—Å–ø–µ—Ö–æ–≤–ê–Ω–∞–ª–∏–∑",
        "system": SYSTEM_PROMPT,
        "prompt_template": """
–¢—ã ‚Äî –∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–∞–Ω–Ω—ã—Ö, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –ø–∏–∫–æ–≤–æ–π –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (Peak Performance).
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–ø–∏—Å–∏ –∑–∞ 30 –¥–Ω–µ–π. –ù–∞–π–¥–∏ –¥–Ω–∏ —Å –≤—ã—Å–æ–∫–æ–π –û—Ü–µ–Ω–∫–æ–π –î–Ω—è (4-5) –∏–ª–∏ –∑–Ω–∞—á–∏–º—ã–º–∏ –£—Å–ø–µ—Ö–∞–º–∏.

–ü—Ä–æ–≤–µ–¥–∏ "–æ–±—Ä–∞—Ç–Ω—ã–π –∏–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥" —ç—Ç–∏—Ö –¥–Ω–µ–π:
1. –ö–∞–∫ —è —Å–ø–∞–ª –Ω–∞–∫–∞–Ω—É–Ω–µ?
2. –û —á–µ–º —è –¥—É–º–∞–ª –∏ —á—Ç–æ –¥–µ–ª–∞–ª (–ø–æ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—É)?
3. –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π "–§–æ—Ä–º—É–ª—É –º–æ–µ–≥–æ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –¥–Ω—è": –Ω–∞–±–æ—Ä —É—Å–ª–æ–≤–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ —É—Å–ø–µ—Ö—É.
""",
    },
    "linguistic_analysis": {
        "name": "–õ–∏–Ω–≥–≤–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏—è",
        "days": 30,
        "filename_slug": "–õ–∏–Ω–≥–≤–æ–ê–Ω–∞–ª–∏–∑",
        "system": SYSTEM_PROMPT,
        "prompt_template": """
–ë—É–¥—å –≤ —Ä–æ–ª–∏: —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø—Å–∏—Ö–æ–ª–∏–Ω–≥–≤–∏—Å—Ç–∏–∫–µ. –¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –Ω–µ —Ñ–∞–∫—Ç—ã, –∞ —Å–ª–æ–≤–∞ –∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Ä–µ—á–∏.
–ü—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–π –º–µ—Ç–∞-–¥–∞–Ω–Ω—ã–µ (—Å–æ–Ω, –æ—Ü–µ–Ω–∫–∏) –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –≤ —Ä–∞–∑–¥–µ–ª–∞—Ö [–ü–æ–ª–Ω—ã–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç] –∑–∞ 30 –¥–Ω–µ–π.

1. **–ì–ª–∞–≥–æ–ª—ã:** –Ø —á–∞—â–µ –∏—Å–ø–æ–ª—å–∑—É—é –∞–∫—Ç–∏–≤–Ω—ã–µ (—Å–¥–µ–ª–∞–ª, —Ä–µ—à–∏–ª) –∏–ª–∏ –ø–∞—Å—Å–∏–≤–Ω—ã–µ (–ø—Ä–∏—à–ª–æ—Å—å, —Å–ª—É—á–∏–ª–æ—Å—å, —É—Å—Ç–∞–ª) —Ñ–æ—Ä–º—ã? –ß—Ç–æ —ç—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –æ –º–æ–µ–º –ª–æ–∫—É—Å–µ –∫–æ–Ω—Ç—Ä–æ–ª—è?
2. **–£–±–µ–∂–¥–µ–Ω–∏—è:** –ï—Å—Ç—å –ª–∏ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∞–º–æ–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–∏–µ —Ñ—Ä–∞–∑—ã (–Ω–∞—Ä—Ä–∞—Ç–∏–≤—ã)? (–ù–∞–ø—Ä–∏–º–µ—Ä: "–Ø –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É—Å–ø–µ–≤–∞—é", "–≠—Ç–æ —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–æ").
3. **–û–∫—Ä—É–∂–µ–Ω–∏–µ:** –ö–æ–≥–æ –∏–∑ –ª—é–¥–µ–π —è —É–ø–æ–º–∏–Ω–∞—é –≤ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–º –∫–ª—é—á–µ, –∞ –∫–æ–≥–æ ‚Äî –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å—Ç—Ä–µ—Å—Å–∞?
""",
    },
    "laboratory": {
        "name": "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è (–ü–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤)",
        "days": 14,
        "filename_slug": "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è",
        "system": "",
        "prompt_template": """
–ë—É–¥—å –≤ —Ä–æ–ª–∏: –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å –¥–∞–Ω–Ω—ã—Ö. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–π—Ç–∏ –∞–Ω–æ–º–∞–ª–∏–∏ –∏ —Å–∫—Ä—ã—Ç—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
–ü—Ä–æ—Å–º–æ—Ç—Ä–∏ –≤—Å–µ –∑–∞–ø–∏—Å–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–π—Ç–∏ —Ç–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–∂–Ω—ã –¥–ª—è –º–µ–Ω—è, –Ω–æ —è –Ω–µ –≤—ã–¥–µ–ª—è—é –∏—Ö –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∫–∞–∫ –°–æ–Ω –∏–ª–∏ –ë–æ–ª–∏).
–ö–∞–∫–∏–µ —Ç–µ–º—ã –≤—Å–ø–ª—ã–≤–∞–ª–∏ —á–∞—â–µ –≤—Å–µ–≥–æ –≤ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞—Ö? (–ü—Ä–∏–º–µ—Ä—ã: –ï–¥–∞, –ü–æ–≥–æ–¥–∞, –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã, –î–µ–Ω—å–≥–∏, –¢–µ—Ö–Ω–∏–∫–∞).

–ü—Ä–µ–¥–ª–æ–∂–∏ 1-2 –Ω–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ "—Ñ–æ–Ω—è—Ç" –≤ –º–æ–∏—Ö –∑–∞–ø–∏—Å—è—Ö.
""",
    },
}


def get_journal_entries(days_back, extract_transcript_only=False):
    """–°–æ–±–∏—Ä–∞–µ—Ç —Ç–µ–∫—Å—Ç –∑–∞–º–µ—Ç–æ–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π.

    Args:
        days_back: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        extract_transcript_only: –ï—Å–ª–∏ True, –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ '## –ü–æ–ª–Ω—ã–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç'
    """
    entries_text = []
    today = datetime.date.today()

    log(f"–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–æ–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {days_back} –¥–Ω–µ–π...")

    for i in range(days_back):
        # –ò–¥–µ–º –æ—Ç –ø—Ä–æ—à–ª–æ–≥–æ –∫ –Ω–∞—Å—Ç–æ—è—â–µ–º—É –∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç?
        # –õ—É—á—à–µ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏: –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ –∫ –Ω–æ–≤–æ–º—É
        date_target = today - datetime.timedelta(days=(days_back - 1 - i))
        filename = date_target.strftime("%Y%m%d") + ".md"
        filepath = os.path.join(JOURNAL_DIR, filename)

        if os.path.exists(filepath):
            with open(filepath, "r", encoding="utf-8") as f:
                content = f.read()

                # –ï—Å–ª–∏ –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç, –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ '## –ü–æ–ª–Ω—ã–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç'
                if extract_transcript_only:
                    if "## –ü–æ–ª–Ω—ã–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç" in content:
                        transcript_part = content.split("## –ü–æ–ª–Ω—ã–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç", 1)[1]
                        content = transcript_part.strip()
                    else:
                        # –ï—Å–ª–∏ —Ä–∞–∑–¥–µ–ª–∞ –Ω–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø–∏—Å—å
                        continue

                # –§–∏–ª—å—Ç—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏
                filtered_lines = []
                for line in content.split("\n"):
                    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å --- –∏–ª–∏ |
                    if (
                        line.startswith("---")
                        or line.startswith("|")
                        or line.startswith("date")
                        or line.startswith("type")
                    ):
                        continue
                    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å [[–î–Ω–µ–≤–Ω–∏–∫]] –∏ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã ![[AudioLinks/...]]
                    if "[[–î–Ω–µ–≤–Ω–∏–∫]]" in line or line.strip().startswith("![["):
                        continue
                    filtered_lines.append(line)

                # –°–∂–∏–º–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –æ–¥–Ω—É
                cleaned_content = "\n".join(filtered_lines)
                while "\n\n\n" in cleaned_content:
                    cleaned_content = cleaned_content.replace("\n\n\n", "\n\n")

                entries_text.append(
                    f"--- –ó–ê–ü–ò–°–¨ –û–¢ {date_target.strftime('%Y-%m-%d')} ---\n{cleaned_content}\n"
                )
        else:
            # –ú–æ–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–ø—É—Å–∫–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            pass

    return "\n".join(entries_text)


def save_markdown(folder, filename, content):
    os.makedirs(folder, exist_ok=True)
    path = os.path.join(folder, filename)
    with open(path, "w", encoding="utf-8") as f:
        f.write(content)
    return path


def main():
    parser = argparse.ArgumentParser(
        description="–ú—É–¥—Ä—ã–π –ë—Ä–æ ‚Äî –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–Ω–µ–≤–Ω–∏–∫–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π"
    )

    available_keys = ", ".join(sorted(ANALYSIS_TYPES.keys()))

    parser.add_argument(
        "analysis",
        nargs="?",
        help=(
            f'–ö–ª—é—á –∞–Ω–∞–ª–∏–∑–∞ (–æ–¥–∏–Ω –∏–∑: {available_keys}) –∏–ª–∏ "all" –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö.'
            " –ë–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫."
        ),
    )

    args = parser.parse_args()

    if not ensure_ollama():
        log("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å Ollama.")
        return

    # –ï—Å–ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–º–æ—â—å
    if args.analysis is None:
        print("\nüëã –ú—É–¥—Ä—ã–π –ë—Ä–æ ‚Äî –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–Ω–µ–≤–Ω–∏–∫–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π")
        print(f"–ü–∞–ø–∫–∞ –¥–Ω–µ–≤–Ω–∏–∫–∞: {JOURNAL_DIR}\n")
        print("–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∞–Ω–∞–ª–∏–∑–∞:\n")

        for key, val in ANALYSIS_TYPES.items():
            print(f"  {key}  {val['name']} (–ê–Ω–∞–ª–∏–∑ –∑–∞ {val['days']} –¥–Ω.)")

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ—Ä–æ—Ç–∫–∏–π —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        print(f"\n–ö–ª—é—á–∏: {available_keys}")

        print("\n–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:")
        print(
            "  uv run wisdom_bro.py weekly_retro          # –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ–¥–µ–ª—å–Ω—ã–π —Ä–µ—Ç—Ä–æ-–∞–Ω–∞–ª–∏–∑"
        )
        print("  uv run wisdom_bro.py all                  # –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –∞–Ω–∞–ª–∏–∑—ã")
        print(
            "  uv run wisdom_bro.py health_check          # –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ—Ç–µ–∫—Ç–æ—Ä –≤—ã–≥–æ—Ä–∞–Ω–∏—è"
        )
        return

    # –ó–∞–ø—É—Å–∫ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
    if args.analysis == "all":
        for key in ANALYSIS_TYPES:
            run_analysis(key)
    elif args.analysis in ANALYSIS_TYPES:
        run_analysis(args.analysis)
    else:
        print(f"–û—à–∏–±–∫–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–ª—é—á –∞–Ω–∞–ª–∏–∑–∞ '{args.analysis}'")
        print(f"–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–ª—é—á–∏: {available_keys}")
        print("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'uv run wisdom_bro.py' –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏")


def run_analysis(key):
    """–ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞: —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –¥–∏—Å–∫ (–±–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è)."""
    cfg = ANALYSIS_TYPES[key]
    log(f"--- –ó–∞–ø—É—Å–∫: {cfg['name']} ---")

    # 1. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
    # –î–ª—è "–õ–∏–Ω–≥–≤–æ–ê–Ω–∞–ª–∏–∑" –∏ "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è" –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç
    extract_transcript = key in ["linguistic_analysis", "laboratory"]
    context_data = get_journal_entries(
        cfg["days"], extract_transcript_only=extract_transcript
    )
    if not context_data:
        log("‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.")
        return

    # 2. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞
    full_prompt = (
        f"{cfg['prompt_template']}\n\n=== –î–ê–ù–ù–´–ï –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê ===\n{context_data}"
    )

    # 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ (–¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏)
    date_str = datetime.date.today().strftime("%Y-%m-%d")
    prompt_filename = f"{date_str}_{cfg['filename_slug']}_Prompt.md"
    save_markdown(ANALYSIS_DIR, prompt_filename, f"# –ó–∞–¥–∞–Ω–∏–µ –¥–ª—è AI\n\n{full_prompt}")
    log(f"üìÑ –ü—Ä–æ–º–ø—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {prompt_filename}")

    # 4. –ó–∞–ø—Ä–æ—Å –∫ AI
    log("üß† AI –¥—É–º–∞–µ—Ç... (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è)")
    client = OpenAI(base_url=OLLAMA_API_URL, api_key="ollama")

    try:
        response = client.chat.completions.create(
            model=OLLAMA_MODEL,
            messages=[
                {"role": "system", "content": cfg["system"]},
                {"role": "user", "content": full_prompt},
            ],
            temperature=0.7,
        )
        result_text = response.choices[0].message.content

        # 5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        result_filename = f"{date_str}_{cfg['filename_slug']}_Qwen.md"

        md_output = f"""---
date: {date_str}
type: –∞–Ω–∞–ª–∏–∑
model: {OLLAMA_MODEL}
task: {cfg['name']}
---
# {cfg['name']}
[[{prompt_filename}|–ò—Å—Ö–æ–¥–Ω—ã–π –ø—Ä–æ–º–ø—Ç]]

{result_text}
"""
        save_path = save_markdown(ANALYSIS_DIR, result_filename, md_output)
        log(f"‚úÖ –ì–æ—Ç–æ–≤–æ! –†–µ–∑—É–ª—å—Ç–∞—Ç: {save_path}")
        send_notification(
            "–ú—É–¥—Ä—ã–π –ë—Ä–æ",
            f"'{cfg['name']}' {date_str} –≥–æ—Ç–æ–≤!",
        )

    except Exception as e:
        log(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å AI: {e}")


if __name__ == "__main__":
    main()
